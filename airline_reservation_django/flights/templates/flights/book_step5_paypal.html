{% extends 'flights/base.html' %}
{% block content %}
<h1>Step 5: Pay with PayPal</h1>

<p>Flight: <strong>{{ flight.departure_city }} → {{ flight.arrival_city }}</strong></p>
<p>Total Price: <strong>€{{ total_price }}</strong></p>

<hr>
<div id="paypal-button-container"></div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

const script = document.createElement('script');
script.src = "https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=EUR";
script.onload = function() {
    paypal.Buttons({
        style: { color: 'gold', shape: 'rect', label: 'pay' },
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: { value: '{{ total_price|floatformat:2 }}' },
                    description: 'Flight booking - {{ flight.departure_city }} to {{ flight.arrival_city }}'
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                fetch("", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({ orderID: data.orderID, details: details })
                })
                .then(resp => resp.json())
                .then(res => {
                    if (res.status === 'ok') {
                        window.location.href = "{% url 'book_success' %}";
                    } else {
                        alert('Payment recorded but server error occurred.');
                    }
                });
            });
        },
        onError: function(err) {
            console.error(err);
            alert('PayPal error: ' + err);
        }
    }).render('#paypal-button-container');
};
document.body.appendChild(script);
</script>
{% endblock %}
